<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamlandJS Hydration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .counter {
            font-size: 18px;
            font-weight: bold;
            color: #007acc;
            margin: 10px 0;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: white;
        }
        button:hover {
            background: #f0f0f0;
        }
        .log {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>DreamlandJS Hydration Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Basic Hydration</h2>
        <p>This tests hydrating a simple component with existing DOM.</p>
        
        <div id="basic-test">
            <h3>Hello World</h3>
            <p>This is static content.</p>
        </div>
        
        <button onclick="testBasicHydration()">Test Basic Hydration</button>
        <div id="basic-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Component with State</h2>
        <p>This tests hydrating a component that has internal state.</p>
        
        <div id="state-test">
            <h3>Counter: 0</h3>
            <button>Increment</button>
            <button>Decrement</button>
        </div>
        
        <button onclick="testStateHydration()">Test State Hydration</button>
        <div id="state-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Fresh Component (Reference)</h2>
        <p>This creates a fresh component for comparison.</p>
        
        <div id="fresh-component"></div>
        
        <button onclick="testFreshComponent()">Create Fresh Component</button>
        <div id="fresh-result"></div>
    </div>

    <div class="test-section">
        <h2>Console Log</h2>
        <div id="console-log" class="log"></div>
    </div>

    <script type="module">
        // Import DreamlandJS
        import { h, jsx, hydrate, createState } from './dist/core.js';

        // Make available globally for easier testing
        window.jsx = jsx;
        window.h = h;
        window.hydrate = hydrate;
        window.createState = createState;

        // Set up console logging
        const logEl = document.getElementById('console-log');
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = (...args) => {
            originalLog(...args);
            logEl.textContent += args.join(' ') + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        };
        
        console.error = (...args) => {
            originalError(...args);
            logEl.textContent += '[ERROR] ' + args.join(' ') + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        };

        // Test Components
        function BasicComponent() {
            console.log('BasicComponent: called with this =', this);
            
            return jsx("div", {}, [
                jsx("h3", {}, "Hello World"),
                jsx("p", {}, "This is static content.")
            ]);
        }

        function CounterComponent() {
            console.log('CounterComponent: called with this =', this);
            
            // Initialize state
            this.count = this.count || 0;
            
            // Add CSS
            this.css = `
                .counter { 
                    color: #007acc; 
                    font-weight: bold; 
                }
                button:hover { 
                    background-color: #e0e0e0; 
                }
            `;
            
            console.log('CounterComponent: count =', this.count);

            return jsx("div", {}, [
                jsx("h3", {}, `Counter: ${this.count}`),
                jsx("button", { 
                    "on:click": () => {
                        this.count++;
                        console.log('Incremented to:', this.count);
                    }
                }, "Increment"),
                jsx("button", { 
                    "on:click": () => {
                        this.count--;
                        console.log('Decremented to:', this.count);
                    }
                }, "Decrement")
            ]);
        }

        // Test functions
        window.testBasicHydration = function() {
            try {
                console.log('=== Testing Basic Hydration ===');
                const element = document.getElementById('basic-test');
                console.log('Original element:', element);
                console.log('Original innerHTML:', element.innerHTML);
                
                const hydrated = hydrate(element, BasicComponent);
                console.log('Hydrated element:', hydrated);
                console.log('Element $ property:', hydrated.$);
                console.log('Element classList:', [...hydrated.classList]);
                
                document.getElementById('basic-result').innerHTML = 
                    '<span class="success">✓ Basic hydration completed successfully</span>';
                    
            } catch (error) {
                console.error('Basic hydration failed:', error);
                document.getElementById('basic-result').innerHTML = 
                    `<span class="error">✗ Basic hydration failed: ${error.message}</span>`;
            }
        };

        window.testStateHydration = function() {
            try {
                console.log('=== Testing State Hydration ===');
                const element = document.getElementById('state-test');
                console.log('Original element:', element);
                
                const hydrated = hydrate(element, CounterComponent);
                console.log('Hydrated element:', hydrated);
                console.log('Component state:', hydrated.$.state);
                console.log('Element classList:', [...hydrated.classList]);
                
                // Test if buttons work by simulating clicks
                const buttons = element.querySelectorAll('button');
                console.log('Found buttons:', buttons.length);
                
                document.getElementById('state-result').innerHTML = 
                    '<span class="success">✓ State hydration completed. Check console and try clicking buttons.</span>';
                    
            } catch (error) {
                console.error('State hydration failed:', error);
                document.getElementById('state-result').innerHTML = 
                    `<span class="error">✗ State hydration failed: ${error.message}</span>`;
            }
        };

        window.testFreshComponent = function() {
            try {
                console.log('=== Creating Fresh Component ===');
                const container = document.getElementById('fresh-component');
                container.innerHTML = ''; // Clear any existing content
                
                const fresh = jsx(CounterComponent, {});
                container.appendChild(fresh);
                console.log('Fresh component created:', fresh);
                console.log('Fresh component $:', fresh.$);
                
                document.getElementById('fresh-result').innerHTML = 
                    '<span class="success">✓ Fresh component created successfully</span>';
                    
            } catch (error) {
                console.error('Fresh component creation failed:', error);
                document.getElementById('fresh-result').innerHTML = 
                    `<span class="error">✗ Fresh component creation failed: ${error.message}</span>`;
            }
        };

        console.log('DreamlandJS Hydration Test loaded');
        console.log('Available functions: testBasicHydration, testStateHydration, testFreshComponent');
    </script>
</body>
</html>